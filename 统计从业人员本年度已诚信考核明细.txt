USE [XNYZ]
GO
/****** Object:  StoredProcedure [dbo].[SP_RP_T_EcertCredit]    Script Date: 01/05/2016 15:27:44 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[SP_RP_T_EcertCredit]
@idcard VARCHAR(20),
@ziparea VARCHAR(6)

AS
BEGIN
	SET NOCOUNT ON;
	IF 1=0 BEGIN
	SET FMTONLY OFF
	END

	CREATE table #TMP (从业证号	NUMERIC(16,0), 姓名 VARCHAR(50),身份证号 VARCHAR(20),经营范围 VARCHAR(50),
	考核周期开始日期 DATETIME,考核周期截止日期 DATETIME,考核时间 DATETIME,诚信考核记录ID NUMERIC(16,0),
	行政区域 VARCHAR(6),状态 VARCHAR(10),诚信等级 VARCHAR(20),考核周期累计计分 TINYINT );
	
	INSERT INTO #TMP 
	SELECT  b.ID_ECERT,c.NAME,c.ID_ECERT AS idcard,b.MGRSORT,a.CHECKBEGINDATE,
	a.CHECKENDDATE,a.CREDITDATE,a.ID_ECERTCREDIT,a.ZIPAREA,a.STATE,a.CREDIT,a.TOTALSCORE
	FROM dbo.T_EcertCredit2013 a,T_ECertArea2013 b,T_ECert2013 c
	WHERE a.ID_ECERTAREA = b.ID_ECERTAREA AND b.ID_ECERT = c.ID_ECERT AND c.ECERTSTATE = '从业' AND a.STATE = '有效'
	AND YEAR(a.CHECKENDDATE) > YEAR(GETDATE())
	AND a.ZIPAREA = @ziparea;
	
	INSERT INTO #TMP
	SELECT a.ID_ECERT,b.NAME,b.IDCARD,
	b.ECERTAREA,a.CHECKBEGINDATE,a.CHECKENDDATE,a.CREDITDATE,
	a.ID_ECERTCREDIT,a.ZIPAREA,a.CREDITSTATUS,a.CREDIT,a.TOTALSCORE
	FROM T_EcertCredit a,T_Ecert b WHERE
	a.ID_ECERT = b.ID_ECERT AND a.CREDITSTATUS = '有效' AND b.ECERTSTATE = '从业'
	AND  YEAR(a.CHECKENDDATE) > YEAR(GETDATE())
	AND a.ZIPAREA = @ziparea;
	
	IF(@idcard = '')
	begin
	SELECT * from #TMP 
	END
	ELSE
	BEGIN
	SELECT * from #TMP WHERE 身份证号 = @idcard;
	END
	
	
END

	
	
	
	



